%!TEX program = xelatex

% TODO: \nend 未使用正确的的字体
% TODO: \nend 不可用于 \title 之中
% TODO: \nend 存在重复条目
% TODO: \tdoc 与 \tpart 暂未显示页码范围
% TODO: \nauthor 与 \neditor 之间的垂直间距需要微调
% TODO: 自动反向更新下游仓库

\documentclass[
  zihao=5,
  punct=kaiming,
  linespread=1.4,
  sub4section,
]{ctexbook}

% ------------------------------------------------------------------------------
% 导言区
% ------------------------------------------------------------------------------

\usepackage{bigfoot}
\usepackage{calc}
\usepackage{CJKfntef}
\usepackage{enotez}
\usepackage{etoolbox}
\usepackage{fancyhdr}
\usepackage{fontspec}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage[hidelinks,hyperfootnotes=true]{hyperref}
\usepackage{bookmark}
\usepackage{lipsum}
\usepackage{perpage}
\usepackage{scrextend}
\usepackage{tikz}
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{truncate}
\usepackage{ulem}
\usepackage{xcolor}
\usepackage{xifthen}
\usepackage{xparse}
\usepackage{xunicode-addon}

\raggedbottom
\newsavebox{\headerbox}

\usepackage{xeCJKfntef}
\xeCJKsetup{underdot/symbol={\raisebox{-5pt}{◦}}}
\newcommand{\dotemph}[1]{\CJKunderdot{#1}}

% --------------------------------------
% 字体定义
% --------------------------------------

\setCJKmainfont{FZShuSong}
[
  Path           = fonts/,
  BoldFont       = FZHei,
  ItalicFont     = FZKai,
  BoldItalicFont = FZHei,
]
\setCJKsansfont{FZHei}[Path=fonts/]
\setCJKmonofont{HYFangSong}[Path=fonts/]

\setCJKfamilyfont{ss}{FZShuSong}[Path=fonts/]
\setCJKfamilyfont{fs}{FZFangSong}[Path=fonts/]
\setCJKfamilyfont{ht}{FZHei}[Path=fonts/]
\setCJKfamilyfont{kt}{FZKai}[Path=fonts/]
\setCJKfamilyfont{xb}{FZXiaoBiaoSong}[Path=fonts/]
\setCJKfamilyfont{xh}{FZXiHeiI}[Path=fonts/]
\setCJKfamilyfont{sz}{Berthold Baskerville Book}[Path=fonts/]

% 为封面设计的压缩字体
\newCJKfontfamily\coverxb{FZXiaoBiaoSong}[Path=fonts/, FakeStretch=0.85]
\newCJKfontfamily\coverxh{FZXiHeiI}[Path=fonts/, FakeStretch=0.85]

% 定义经过轻微压缩的字体族 (90%)
\newCJKfontfamily\modifiedss{FZShuSong}[Path=fonts/, FakeStretch=0.9]
\newCJKfontfamily\modifiedfs{FZFangSong}[Path=fonts/, FakeStretch=0.9]
\newCJKfontfamily\modifiedht{FZHei}[Path=fonts/, FakeStretch=0.9]
\newCJKfontfamily\modifiedkt{FZKai}[Path=fonts/, FakeStretch=0.9]
\newCJKfontfamily\modifiedxb{FZXiaoBiaoSong}[Path=fonts/, FakeStretch=0.9]
\newCJKfontfamily\modifiedxh{FZXiHeiI}[Path=fonts/, FakeStretch=0.9]

% 定义经过更轻微压缩的字体族 (95%)
\newCJKfontfamily\modifiedmodifiedss{FZShuSong}[Path=fonts/, FakeStretch=0.95]
\newCJKfontfamily\modifiedmodifiedfs{FZFangSong}[Path=fonts/, FakeStretch=0.95]
\newCJKfontfamily\modifiedmodifiedht{FZHei}[Path=fonts/, FakeStretch=0.95]
\newCJKfontfamily\modifiedmodifiedkt{FZKai}[Path=fonts/, FakeStretch=0.95]
\newCJKfontfamily\modifiedmodifiedxb{FZXiaoBiaoSong}[Path=fonts/,
FakeStretch=0.95]
\newCJKfontfamily\modifiedmodifiedxh{FZXiHeiI}[Path=fonts/, FakeStretch=0.95]

% 标点符号样式设置
\xeCJKEditPunctStyle{kaiming}
{
  fixed-margin-ratio = 0.000,
  mixed-margin-ratio = 1.000,
  middle-margin-ratio = 0.000,
}

% --------------------------------------
% 版面与边距
% --------------------------------------

\geometry{
  paperwidth  = 437bp,
  paperheight = 613bp,
  top         = 94.3bp,
  bottom      = 60.0bp,
  left        = 76.5bp,
  right       = 66.5bp,
  headsep     = 25.0bp,
  footskip    = 17.0bp,
  footnotesep = 11bp,
}

% --------------------------------------
% 页眉、页脚与页码
% --------------------------------------

\pagestyle{fancy}

\fancyhf{}

% 页眉与页脚

\renewcommand{\headrulewidth}{0bp}

\fancyhead[RO]{\rightmark}
\fancyhead[LE]{\leftmark}

\renewcommand{\chaptermark}[1]{%
  \sbox{\headerbox}{\small\modifiedxh#1}%
  \ifdim\wd\headerbox > 20em
  \def\theheadermark{\truncate[……]{20em}{\small\modifiedxh#1}}%
  \else
  \def\theheadermark{\small\modifiedxh#1}%
  \fi
  \markboth{\theheadermark}{}%
}

\renewcommand{\sectionmark}[1]{%
  \sbox{\headerbox}{\small\modifiedxh#1}%
  \ifdim\wd\headerbox > 20em
  \def\theheadermark{\truncate[……]{20em}{\small\modifiedxh#1}}%
  \else
  \def\theheadermark{\small\modifiedxh#1}%
  \fi
  \markright{\theheadermark}%
}

% 页码

\fancyfoot[RO]{\fontspec{Berthold Baskerville Book}[Path=fonts/]\thepage}
\fancyfoot[LE]{\fontspec{Berthold Baskerville Book}[Path=fonts/]\thepage}

\assignpagestyle{\part}{empty}
\fancypagestyle{empty}{%
  \fancyhf{}%
  \fancyfoot{}%
}

\fancypagestyle{plain}{%
  \fancyhf{}%
  \fancyfoot[RO]{%
    \makebox[0pt][l]{%
      \hspace{3.5bp}%
      \fontspec{Berthold Baskerville Book}[Path=fonts/]\thepage
    }%
  }%
  \fancyfoot[LE]{\fontspec{Berthold Baskerville Book}[Path=fonts/]\thepage}%
}

% --------------------------------------
%  命令导入
% --------------------------------------

\input{title_cmd}
\input{note_cmd}
\input{other_cmd}
\input{appendix_cmd}

% ------------------------------------------------------------------------------
% 正文
% ------------------------------------------------------------------------------

\begin{document}

% --------------------------------------

\input{../cover}

% --------------------------------------

\xeCJKsetup{CJKglue={\hskip 0bp plus 0.02\baselineskip minus
0.000\baselineskip}}
\setlength{\parskip}{0bp}

\clearpage
\fancyhf{}
\renewcommand{\headrulewidth}{0bp}

\fancyhead[RO]{\small\CJKfamily{xh}\scalebox{0.9}[1.0]{\ziju{1.5pt}{目录}}}
\fancyhead[LE]{\small\CJKfamily{xh}\scalebox{0.9}[1.0]{\ziju{1.5pt}{目录}}}
\fancyfoot[RO]{%
  \makebox[0pt][l]{%
    \hspace{3.5bp}%
    \fontspec{Berthold Baskerville Book}[Path=fonts/]\thepage
  }%
}
\fancyfoot[LE]{\hspace{-4.5bp}\makebox[0pt][r]{\fontspec{Berthold
Baskerville Book}[Path=fonts/]\thepage}}
\pagestyle{fancy}

\tableofcontents

\mainmatter

\clearpage
\fancyhf{}
\renewcommand{\headrulewidth}{0bp}

\fancyhead[RO]{\rightmark}
\fancyhead[LE]{\leftmark}
\fancyfoot[RO]{%
  \makebox[0pt][l]{%
    \hspace{3.5bp}%
    \fontspec{Berthold Baskerville Book}[Path=fonts/]\thepage
  }%
}
\fancyfoot[LE]{\hspace{-4.5bp}\makebox[0pt][r]{\fontspec{Berthold
Baskerville Book}[Path=fonts/]\thepage}}
\pagestyle{fancy}

\markboth{}{}

% --------------------------------------

\input{../content}

% --------------------------------------

\cleardoublepage

\pagestyle{endnotestyle}

\printendnotes

\addcontentsline{toc}{chapter}{注释}

% --------------------------------------

\input{../appendix}

\input{../afterword}

% --------------------------------------

\end{document}

% ------------------------------------------------------------------------------
% EOF
% ------------------------------------------------------------------------------
